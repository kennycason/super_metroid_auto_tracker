<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Metroid Live Tracker</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            background: #000; 
            color: #00ff00; 
            margin: 20px; 
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 8px; }
        .header h1 { font-size: 20px; margin: 5px 0; }
        .status-row { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
            margin: 5px 0;
        }
        .status { 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #00ff00; 
            border-radius: 5px; 
            text-align: center;
        }
        .connected { background-color: #001100; }
        .disconnected { background-color: #110000; color: #ff0000; }
        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin: 8px 0; 
        }
        .stat-box { 
            border: 1px solid #00ff00; 
            padding: 8px; 
            border-radius: 5px; 
            background: #001a00;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stat-label { font-size: 12px; opacity: 0.7; min-width: 60px; }
        .stat-value { font-size: 16px; font-weight: bold; }
        .stat-bar { 
            display: none; /* Hidden for compact overlay */
        }
        .stat-bar-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00); 
            transition: width 0.3s ease;
        }
        .game-info { 
            text-align: center; 
            margin: 8px 0; 
            padding: 8px; 
            border: 1px solid #00ff00; 
            border-radius: 5px;
            background: #001a00;
        }
        button { 
            background: #003300; 
            color: #00ff00; 
            border: 1px solid #00ff00; 
            padding: 8px 12px; 
            margin: 5px; 
            border-radius: 3px; 
            cursor: pointer;
        }
        button:hover { background: #005500; }
        .location { font-size: 14px; margin: 0; }
        .error { color: #ff0000; }
        
        /* Item/Boss Grid Styles */
        .tracking-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); 
            gap: 8px; 
            margin: 8px 0; 
            padding: 8px;
            border: 1px solid #00ff00;
            border-radius: 5px;
            background: #001a00;
        }
        .tracking-section { margin: 8px 0; }
        
        /* Direct 64x64 Sprite System - no wrapper needed */
        .sprite {
            display: inline-block;
            width: 64px;
            height: 64px;
            background-image: url('item_sprites.png');
            background-repeat: no-repeat;
            /* Scale the background image 4x: 128x128 -> 512x512 */
            background-size: 512px 512px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            vertical-align: middle;
            margin-right: 4px;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        /* SPRITE SHEET COORDINATE MAPPING
         * 16x16 tiles, using first tile of each 32x16 item
         * Row 0: Morph ball, Bomb, Energy tank
         * Row 1: Missile, Super missile, Power bomb, Reserve tanks
         * Row 2: Hi jump, Speed booster, Grappling beam, X-ray scope  
         * Row 3: Spring ball, Space jump, Screw attack, Charge beam
         * Row 4: Spazer beam, Wave beam, Ice beam, Plasma beam
         * Row 5: Varia suit
         */
        
        /* === ROW 0 (y=0px) === */
        .sprite-morph-ball {
            background-position: 0px 0px; /* Row 0, Col 0 */
        }
        
        .sprite-bomb {
            background-position: -128px 0px; /* Row 0, Col 1 (32px * 4) */
        }
        
        .sprite-energy-tank {
            background-position: -256px 0px; /* Row 0, Col 2 (64px * 4) */
        }
        
        /* === ROW 1 (y=-64px) === */
        .sprite-missile {
            background-position: 0px -64px; /* Row 1, Col 0 (16px * 4) */
        }
        
        .sprite-super-missile {
            background-position: -128px -64px; /* Row 1, Col 1 */
        }
        
        .sprite-power-bomb {
            background-position: -256px -64px; /* Row 1, Col 2 */
        }
        
        .sprite-reserve-tank {
            background-position: -384px -64px; /* Row 1, Col 3 (96px * 4) */
        }
        
        /* === ROW 2 (y=-128px) === */
        .sprite-hijump {
            background-position: 0px -128px; /* Row 2, Col 0 (32px * 4) */
        }
        
        .sprite-speed {
            background-position: -128px -128px; /* Row 2, Col 1 */
        }
        
        .sprite-grapple {
            background-position: -256px -128px; /* Row 2, Col 2 */
        }
        
        .sprite-xray {
            background-position: -384px -128px; /* Row 2, Col 3 */
        }
        
        /* === ROW 3 (y=-192px) === */
        .sprite-spring {
            background-position: 0px -192px; /* Row 3, Col 0 (48px * 4) */
        }
        
        .sprite-space {
            background-position: -128px -192px; /* Row 3, Col 1 */
        }
        
        .sprite-screw {
            background-position: -256px -192px; /* Row 3, Col 2 */
        }
        
        .sprite-charge-beam {
            background-position: -384px -192px; /* Row 3, Col 3 */
        }
        
        /* === ROW 4 (y=-256px) === */
        .sprite-spazer {
            background-position: 0px -256px; /* Row 4, Col 0 (64px * 4) */
        }
        
        .sprite-wave {
            background-position: -128px -256px; /* Row 4, Col 1 */
        }
        
        .sprite-ice {
            background-position: -256px -256px; /* Row 4, Col 2 */
        }
        
        .sprite-plasma {
            background-position: -384px -256px; /* Row 4, Col 3 */
        }
        
        /* === ROW 5 (y=-320px) === */
        .sprite-varia {
            background-position: 0px -320px; /* Row 5, Col 0 (80px * 4) */
        }
        
        .sprite-gravity {
            background-position: -128px -320px; /* Row 5, Col 1 (32px * 4) */
        }

        /* === BOSS SPRITES (64x64 pixels, single row) === */
        .boss-sprite {
            display: inline-block;
            width: 64px;
            height: 64px;
            background-image: url('boss_sprites.png');
            background-repeat: no-repeat;
            /* Full size 64x64 display */
            background-size: 704px 64px; /* 11 sprites × 64px each = 704px */
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            vertical-align: middle;
            margin-right: 4px;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        /* Boss sprite positions (64px spacing) */
        .boss-sprite-b-torizo {
            background-position: 0px 0px; /* Col 0 */
        }

        .boss-sprite-spore-spawn {
            background-position: -64px 0px; /* Col 1 */
        }

        .boss-sprite-kraid {
            background-position: -128px 0px; /* Col 2 */
        }

        .boss-sprite-crocomire {
            background-position: -192px 0px; /* Col 3 */
        }

        .boss-sprite-phantoon {
            background-position: -256px 0px; /* Col 4 */
        }

        .boss-sprite-botwoon {
            background-position: -320px 0px; /* Col 5 */
        }

        .boss-sprite-draygon {
            background-position: -384px 0px; /* Col 6 */
        }

        .boss-sprite-golden-torizo {
            background-position: -448px 0px; /* Col 7 */
        }

        .boss-sprite-ridley {
            background-position: -512px 0px; /* Col 8 */
        }

        .boss-sprite-mother-brain-1 {
            background-position: -576px 0px; /* Col 9 - MB1 */
        }

        .boss-sprite-mother-brain-2 {
            background-position: -640px 0px; /* Col 10 - MB2 */
        }

        .section-title { 
            font-size: 18px; 
            margin-bottom: 10px; 
            text-align: center;
            color: #00ff00;
            text-transform: uppercase;
        }
        .item-tile { 
            width: 64px; 
            height: 64px; 
            border: 2px solid #003300; 
            border-radius: 6px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
            background: #001100;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            margin-bottom: 18px;
            opacity: 0.4; /* Grayed out by default */
            filter: grayscale(100%);
        }
        .item-tile.obtained { 
            border-color: #00ff00; 
            background: #003300; 
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.4);
            opacity: 1;
            filter: grayscale(0%);
        }
        .item-tile.boss-defeated { 
            border-color: #ff0000; 
            background: #330000; 
            box-shadow: 0 0 8px rgba(255, 0, 0, 0.4);
            opacity: 1;
            filter: grayscale(0%);
        }
        .item-name { 
            position: absolute; 
            bottom: -16px; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 9px; 
            opacity: 0.7;
            white-space: nowrap;
            text-align: center;
            min-width: 55px;
            color: #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SUPER METROID LIVE TRACKER</h1>
            <div class="status-row">
                <div id="status" class="status disconnected">DISCONNECTED</div>
                <button id="toggleBtn" onclick="toggleConnection()">CONNECT</button>
            </div>
        </div>

        <div class="game-info" id="gameInfo" style="display:none;">
            <div class="location">
                <span id="location">Crateria</span> 
                <span id="roomInfo">Room: 0</span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">ENERGY</div>
                <div class="stat-value" id="healthValue">??? / ???</div>
                <div class="stat-value-reserve" id="reserveValue" style="display:none; font-size: 10px; color: #ffaa00; margin-top: 2px;">Reserve: ??? / ???</div>
                <div class="stat-bar">
                    <div class="stat-bar-fill" id="healthBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="stat-box">
                <div class="stat-label">MISSILES</div>
                <div class="stat-value" id="missileValue">??? / ???</div>
                <div class="stat-bar">
                    <div class="stat-bar-fill" id="missileBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="stat-box">
                <div class="stat-label">SUPER MISSILES</div>
                <div class="stat-value" id="superValue">??? / ???</div>
                <div class="stat-bar">
                    <div class="stat-bar-fill" id="superBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="stat-box">
                <div class="stat-label">POWER BOMBS</div>
                <div class="stat-value" id="powerValue">??? / ???</div>
                <div class="stat-bar">
                    <div class="stat-bar-fill" id="powerBar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Item Tracking Grid -->
        <div class="tracking-section">
            <!-- <div class="section-title">🔧 Equipment & Items</div> -->
            <div class="tracking-grid" id="itemsGrid">
                <!-- Major Items -->
                <div class="item-tile" data-item="morph" title="Morph Ball"><span class="sprite sprite-morph-ball"></span><div class="item-name">Morph</div></div>
                <div class="item-tile" data-item="bombs" title="Bombs"><span class="sprite sprite-bomb"></span><div class="item-name">Bombs</div></div>
                <div class="item-tile" data-item="charge" title="Charge Beam"><span class="sprite sprite-charge-beam"></span><div class="item-name">Charge</div></div>
                <div class="item-tile" data-item="spazer" title="Spazer Beam"><span class="sprite sprite-spazer"></span><div class="item-name">Spazer</div></div>
                <div class="item-tile" data-item="varia" title="Varia Suit"><span class="sprite sprite-varia"></span><div class="item-name">Varia</div></div>
                <div class="item-tile" data-item="hijump" title="Hi-Jump Boots"><span class="sprite sprite-hijump"></span><div class="item-name">HiJump</div></div>
                <div class="item-tile" data-item="speed" title="Speed Booster"><span class="sprite sprite-speed"></span><div class="item-name">Speed</div></div>
                <div class="item-tile" data-item="wave" title="Wave Beam"><span class="sprite sprite-wave"></span><div class="item-name">Wave</div></div>
                <div class="item-tile" data-item="ice" title="Ice Beam"><span class="sprite sprite-ice"></span><div class="item-name">Ice</div></div>
                <div class="item-tile" data-item="grapple" title="Grappling Beam"><span class="sprite sprite-grapple"></span><div class="item-name">Grapple</div></div>
                <div class="item-tile" data-item="xray" title="X-Ray Scope"><span class="sprite sprite-xray"></span><div class="item-name">X-Ray</div></div>
                <div class="item-tile" data-item="plasma" title="Plasma Beam"><span class="sprite sprite-plasma"></span><div class="item-name">Plasma</div></div>
                <div class="item-tile" data-item="gravity" title="Gravity Suit"><span class="sprite sprite-gravity"></span><div class="item-name">Gravity</div></div>
                <div class="item-tile" data-item="space" title="Space Jump"><span class="sprite sprite-space"></span><div class="item-name">Space</div></div>
                <div class="item-tile" data-item="spring" title="Spring Ball"><span class="sprite sprite-spring"></span><div class="item-name">Spring</div></div>
                <div class="item-tile" data-item="screw" title="Screw Attack"><span class="sprite sprite-screw"></span><div class="item-name">Screw</div></div>
            </div>
        </div>

        <!-- Boss Tracking Grid -->
        <div class="tracking-section">
            <!-- <div class="section-title">👹 Boss Battles</div> -->
            <div class="tracking-grid" id="bossGrid">
                <div class="item-tile" data-boss="bomb_torizo" title="Bomb Torizo"><span class="boss-sprite boss-sprite-b-torizo"></span><div class="item-name">B.Torizo</div></div>
                <div class="item-tile" data-boss="spore_spawn" title="Spore Spawn"><span class="boss-sprite boss-sprite-spore-spawn"></span><div class="item-name">Spore</div></div>
                <div class="item-tile" data-boss="kraid" title="Kraid"><span class="boss-sprite boss-sprite-kraid"></span><div class="item-name">Kraid</div></div>
                <div class="item-tile" data-boss="crocomire" title="Crocomire"><span class="boss-sprite boss-sprite-crocomire"></span><div class="item-name">Crocomire</div></div>
                <div class="item-tile" data-boss="phantoon" title="Phantoon"><span class="boss-sprite boss-sprite-phantoon"></span><div class="item-name">Phantoon</div></div>
                <div class="item-tile" data-boss="botwoon" title="Botwoon"><span class="boss-sprite boss-sprite-botwoon"></span><div class="item-name">Botwoon</div></div>
                <div class="item-tile" data-boss="draygon" title="Draygon"><span class="boss-sprite boss-sprite-draygon"></span><div class="item-name">Draygon</div></div>
                <div class="item-tile" data-boss="ridley" title="Ridley"><span class="boss-sprite boss-sprite-ridley"></span><div class="item-name">Ridley</div></div>
                <div class="item-tile" data-boss="golden_torizo" title="Golden Torizo"><span class="boss-sprite boss-sprite-golden-torizo"></span><div class="item-name">G.Torizo</div></div>
                <div class="item-tile" data-boss="mother_brain" title="Mother Brain"><span class="boss-sprite boss-sprite-mother-brain-1"></span><div class="item-name">M.Brain</div></div>
            </div>
        </div>

        <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <span style="color: #00ff00; font-size: 14px;">🔍 Debug Logs</span>
            <div>
                <button onclick="copyLogs()" style="background: #003300; color: #00ff00; border: 1px solid #00ff00; padding: 4px 8px; margin-right: 5px; cursor: pointer; font-size: 12px;">📋 Copy</button>
                <button onclick="clearLogs()" style="background: #003300; color: #00ff00; border: 1px solid #00ff00; padding: 4px 8px; cursor: pointer; font-size: 12px;">🗑️ Clear</button>
            </div>
        </div>
        <div id="debug" style="font-size: 12px; opacity: 0.7; max-height: 200px; overflow-y: auto; border: 1px solid #003300; padding: 8px;"></div>
    </div>

    <script>
        let isConnected = false;
        let updateInterval = null;
        let isAttached = false;

        // Super Metroid memory addresses
        const MEMORY_ADDRESSES = {
            health: "7E09C2",
            maxHealth: "7E09C4", 
            missiles: "7E09C6",
            maxMissiles: "7E09C8",
            supers: "7E09CA",
            maxSupers: "7E09CC",
            powerBombs: "7E09CE",
            maxPowerBombs: "7E09D0",
            gameState: "7E0998",
            roomID: "7E079B",
            areaID: "7E079F",
            // Item bitflags
            itemsCollected: "7E09A4",  // Collected items bitfield
            beamsCollected: "7E09A8",  // Beam weapons bitfield  
            bossesDefeated: "7ED828",  // Bosses defeated bitfield
        };

        const AREAS = {
            0: "Crateria",
            1: "Brinstar", 
            2: "Norfair",
            3: "Wrecked Ship",
            4: "Maridia",
            5: "Tourian"
        };

        // Item bit mappings (itemsCollected address)
        const ITEM_BITS = {
            morph: 0x04,     // Morph Ball
            bombs: 0x08,     // Bombs  
            varia: 0x01,     // Varia Suit
            gravity: 0x20,   // Gravity Suit
            hijump: 0x100,   // Hi-Jump Boots
            speed: 0x200,    // Speed Booster
            space: 0x02,     // Space Jump
            screw: 0x08,     // Screw Attack (different address)
            spring: 0x02,    // Spring Ball
            grapple: 0x40,   // Grappling Beam
            xray: 0x8000     // X-Ray Scope
        };

        // Beam bit mappings (beamsCollected address)  
        const BEAM_BITS = {
            charge: 0x1000,  // Charge Beam
            ice: 0x02,       // Ice Beam
            wave: 0x01,      // Wave Beam
            spazer: 0x04,    // Spazer Beam
            plasma: 0x08     // Plasma Beam
        };

        // Boss bit mappings (bossesDefeated address)
        const BOSS_BITS = {
            bomb_torizo: 0x04,      // Bomb Torizo
            spore_spawn: 0x02,      // Spore Spawn  
            kraid: 0x01,            // Kraid
            crocomire: 0x02,        // Crocomire (different byte)
            phantoon: 0x01,         // Phantoon (different byte)
            botwoon: 0x04,          // Botwoon (different byte)
            draygon: 0x04,          // Draygon
            ridley: 0x01,           // Ridley
            gold_torizo: 0x04,      // Golden Torizo
            mother_brain_1: 0x02,   // Mother Brain Phase 1
            mother_brain_2: 0x08    // Mother Brain Phase 2
        };

        function log(message) {
            const debugDiv = document.getElementById('debug');
            const timestamp = new Date().toLocaleTimeString();
            
            // Check if user is scrolled to bottom before adding message
            const wasAtBottom = debugDiv.scrollTop >= (debugDiv.scrollHeight - debugDiv.clientHeight - 5);
            
            debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            
            // Only auto-scroll if user was at bottom
            if (wasAtBottom) {
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        function copyLogs() {
            const debugDiv = document.getElementById('debug');
            const text = debugDiv.innerText;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    // Visual feedback
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '✅ Copied!';
                    setTimeout(() => btn.textContent = originalText, 1000);
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            // Visual feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '✅ Copied!';
            setTimeout(() => btn.textContent = originalText, 1000);
        }

        function clearLogs() {
            const debugDiv = document.getElementById('debug');
            debugDiv.innerHTML = '';
            log('🗑️ Debug logs cleared');
        }

        function updateStatus(message, connected) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = connected ? 'status connected' : 'status disconnected';
        }

        function updateToggleButton(connected) {
            document.getElementById('toggleBtn').textContent = connected ? 'DISCONNECT' : 'CONNECT';
        }

        function connect() {
            log("Connecting to UDP Tracker...");
            
            // Test the API connection
            fetch('http://localhost:3000/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.connected && data.game_loaded) {
                        isConnected = true;
                        isAttached = true;
                        updateStatus('TRACKING SUPER METROID', true);
                        updateToggleButton(true);
                        log("✅ Connected to RetroArch via UDP");
                        log(`🎯 Game: ${data.game_info}`);
                        document.getElementById('gameInfo').style.display = 'block';
                        startTracking();
                    } else if (data.connected) {
                        isConnected = true;
                        updateStatus('CONNECTED - NO GAME', true);
                        updateToggleButton(true);
                        log("✅ Connected to RetroArch but Super Metroid not loaded");
                    } else {
                        updateStatus('RETROARCH NOT FOUND', false);
                        updateToggleButton(false);
                        log("❌ Could not connect to RetroArch");
                    }
                })
                .catch(error => {
                    updateStatus('TRACKER SERVER NOT RUNNING', false);
                    updateToggleButton(false);
                    log(`❌ Connection error: ${error.message}`);
                    log("💡 Make sure to run: python tracker_web_server.py");
                });
        }

        function disconnect() {
            isConnected = false;
            isAttached = false;
            updateStatus('DISCONNECTED', false);
            updateToggleButton(false);
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            document.getElementById('gameInfo').style.display = 'none';
            log("🔌 Disconnected");
        }

        function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }

        function updateAllDisplays(stats) {
            // Update all stat displays
            updateStatDisplay('health', stats.health, stats.max_health);
            updateStatDisplay('missile', stats.missiles, stats.max_missiles);
            updateStatDisplay('super', stats.supers, stats.max_supers);
            updateStatDisplay('power', stats.power_bombs, stats.max_power_bombs);
            
            // Update reserve energy (show only if available)
            const reserveEl = document.getElementById('reserveValue');
            if (stats.max_reserve_energy && stats.max_reserve_energy > 0) {
                reserveEl.textContent = `Reserve: ${stats.reserve_energy} / ${stats.max_reserve_energy}`;
                reserveEl.style.display = 'block';
            } else {
                reserveEl.style.display = 'none';
            }
            
            // Update item and boss tiles
            updateItemTiles(stats.items || {});
            updateBossTiles(stats.bosses || {});
        }

        function updateLocationInfo(stats) {
            if (stats.area_name) {
                const locationEl = document.getElementById('location');
                const roomEl = document.getElementById('roomInfo');
                
                locationEl.textContent = `${stats.area_name}`;
                roomEl.textContent = `Room: ${stats.room_id || 'Unknown'}`;
            }
        }

        function updateItemTiles(items) {
            // Update each item tile based on collected status
            Object.keys(items).forEach(itemName => {
                const tile = document.querySelector(`[data-item="${itemName}"]`);
                if (tile) {
                    if (items[itemName]) {
                        tile.classList.add('obtained');
                    } else {
                        tile.classList.remove('obtained');
                    }
                }
            });
        }

        function updateBossTiles(bosses) {
            // Update each boss tile based on defeated status
            Object.keys(bosses).forEach(bossName => {
                const tile = document.querySelector(`[data-boss="${bossName}"]`);
                if (tile) {
                    if (bosses[bossName]) {
                        tile.classList.add('boss-defeated');
                    } else {
                        tile.classList.remove('boss-defeated');
                    }
                }
            });
        }

        function startTracking() {
            if (updateInterval) return;
            
            log("🔄 Starting live tracking...");
            updateToggleButton(true);
            updateInterval = setInterval(updateStats, 1000);
            updateStats(); // Initial update
        }

        function updateStats() {
            if (!isConnected || !isAttached) return;
            
            // Fetch stats from HTTP API
            fetch('http://localhost:3000/api/stats')
                .then(response => response.json())
                .then(stats => {
                    if (stats && !stats.error) {
                        updateAllDisplays(stats);
                        updateLocationInfo(stats);
                        // logDebugInfo(stats);  // Debug disabled - charge beam should work now
                    } else {
                        log(`❌ Stats error: ${stats.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    log(`❌ Failed to fetch stats: ${error.message}`);
                    // Try to reconnect
                    setTimeout(connect, 2000);
                });
        }

        function logDebugInfo(stats) {
            if (stats.debug) {
                log(`🔍 DEBUG - Items: ${stats.debug.items_raw}, Beams: ${stats.debug.beams_raw}, Bosses: ${stats.debug.bosses_raw}`);
            }
        }



        function updateStatDisplay(type, current, max) {
            const valueEl = document.getElementById(type + 'Value');
            const barEl = document.getElementById(type + 'Bar');
            
            if (valueEl && barEl) {
                valueEl.textContent = `${current} / ${max}`;
                const percentage = max > 0 ? (current / max) * 100 : 0;
                barEl.style.width = percentage + '%';
            }
        }

        // Auto-connect on page load
        window.onload = function() {
            log("🚀 Super Metroid UDP Tracker ready");
            log("📡 Make sure tracker_web_server.py is running");
            log("📡 Click CONNECT to start tracking");
        };
    </script>
</body>
</html> 